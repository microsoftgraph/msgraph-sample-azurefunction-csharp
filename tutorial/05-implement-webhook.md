<!-- markdownlint-disable MD002 MD041 -->

In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.

- The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.
- The `Notify` function will act as the webhook that receives change notifications generated by the subscription.

Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph. Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.

## Add client credentials authentication to the Azure Functions project

In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.

1. Open your CLI in the directory that contains **GraphTutorial.csproj**.

1. Add your webhook application ID and secret to the secret store using the following commands. Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**. Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### Create a client credentials authentication provider

1. Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.

- In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package. It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.
- In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application. The client credentials token flow is always non-interactive.
- It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.

## Update GraphClientService

1. Open **GraphClientService.cs** and add the following property to the class.

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. Replace the existing `GetAppGraphClient` function with the following.

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientFunctions":::

## Implement Notify function

In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.

1. Create a new directory in the **GraphTutorials** directory named **Models**.

1. Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. Create a new file in the **Models** directory named **ChangeNotification.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotification.cs" id="ChangeNotificationSnippet":::

1. Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

Take a moment to consider what the code in **Notify.cs** does.

- The `Run` function checks for the presence of a `validationToken` query parameter. If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.
- If the request is not a validation request, the JSON payload is deserialized into a `NotificationList`.
- Each notification in the list is checked for the expected client state value, and is processed.
- The message that triggered the notification is retrieved with Microsoft Graph.

## Implement SetSubscription function

In this section, you'll implement the SetSubscription function. This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.

1. Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

Take a moment to consider what the code in **SetSubscription.cs** does.

- The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.
- If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox. The subscription will notify when messages are created or updated. The new subscription is returned in the JSON payload of the response.
- If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.

## Call SetSubscription from the test app

In this section, you'll implement functions to create and delete subscriptions in the test app.

1. Open **./TestClient/azurefunctions.js** and add the following function.

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.

1. Add the following function to **azurefunctions.js**.

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    This code calls the `SetSubscription` Azure Function to un and removes the subscription from the array of subscriptions in the session.

1. If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.

1. Add the ngrok URL to the user secrets store by running the following command.

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > If you restart ngrok, you will need to repeat this command to update your ngrok URL.

1. Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.

    ```Shell
    func start
    ```

1. Refresh the SPA and select the **Subscriptions** nav item. Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox. This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`. Click **Subscribe**.

1. The page refreshes showing the new subscription in the table.

1. Send an email to the user. After a brief time, the `Notify` function should be called. You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. In the test app, click **Delete** in the table row for the subscription. The page refreshes and the subscription is no longer in the table.
